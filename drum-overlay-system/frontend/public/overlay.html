<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drum Visualizer Overlay</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Courier New', Courier, monospace; }
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        #start-btn { pointer-events: auto; padding: 10px 20px; background: #fff; color: #000; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        canvas { display: block; }
    </style>
    <!-- Import Map for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <div id="ui-layer">
        <h1>DRUM OVERLAY SYSTEM</h1>
        <p>Status: <span id="status">Waiting for input...</span></p>
        <button id="start-btn">INITIALIZE SYSTEM</button>
    </div>
    
    <audio id="audio-track" src="track.wav" crossorigin="anonymous"></audio>

    <script type="module">
        import * as THREE from 'three';
        
        let camera, scene, renderer, mesh;
        let drumData = null;
        let isRunning = false;
        const audio = document.getElementById('audio-track');
        const status = document.getElementById('status');

        init();
        animate();

        async function init() {
            // Scene Setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Object (A reactive sphere)
            const geometry = new THREE.IcosahedronGeometry(1, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            // Load Data
            try {
                const res = await fetch('drum-data.json');
                drumData = await res.json();
                status.innerText = "Data Loaded. Ready.";
            } catch (e) {
                status.innerText = "Error: drum-data.json not found.";
                console.error(e);
            }

            // Event Listeners
            document.getElementById('start-btn').addEventListener('click', () => {
                if(drumData) {
                    audio.play();
                    isRunning = true;
                    status.innerText = "Running...";
                    document.getElementById('start-btn').style.display = 'none';
                }
            });
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRunning && drumData) {
                const time = audio.currentTime;
                // Find the closest frame in data
                const frameIndex = Math.floor(time * drumData.fps);
                
                if (frameIndex < drumData.data.length) {
                    const frame = drumData.data[frameIndex];
                    
                    // React to intensity
                    const scale = 1 + (frame.intensity * 1.5);
                    mesh.scale.set(scale, scale, scale);
                    mesh.rotation.x += 0.01 + (frame.intensity * 0.05);
                    mesh.rotation.y += 0.01 + (frame.intensity * 0.05);
                    
                    // Color shift on beat
                    if (frame.is_beat) {
                        mesh.material.color.setHex(0xffffff);
                    } else {
                        mesh.material.color.lerp(new THREE.Color(0x00ff00), 0.1);
                    }
                }
            } else {
                mesh.rotation.x += 0.005;
                mesh.rotation.y += 0.005;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>